# 创建一般索引(单键、复合)的原则

+ keys 按照过滤文档的能力倒序排列
+ 查询中无排序，则 key 的正反向无关紧要
+ 若查询的结果集占总文档比例很高(>30%)，那么即便命中索引，也不会大幅度的减少查询时间(fetch docs)
+ 一般应用都会有 limit 限制(20-1000)，所以建立索引总是有效的

# 为 count 建立索引的原则

TODO:

# 创建排序索引的原则

- 排序 key 必须处于范围匹配 key 之前，也就是精确匹配 key 之后
- 查询中范围匹配的 key 必须位于索引的末位置

```
{精确匹配 keys, 排序 keys, 范围匹配 keys}
```

## 栗子

documents:
```
{"name": "oonexdl", "gender": "male", "age": 20, "weight": 123}
{"name": "oonexdl", "gender": "male", "age": 21, "weight": 122}
{"name": "oonexdl", "gender": "male", "age": 21, "weight": 127}
{"name": "oonexdl", "gender": "male", "age": 23, "weight": 124}
{"name": "oonexdl", "gender": "male", "age": 24, "weight": 124}
{"name": "oonexdl", "gender": "female", "age": 23, "weight": 121}
{"name": "oonexdl", "gender": "female", "age": 22, "weight": 123}
{"name": "oonexdl", "gender": "female", "age": 22, "weight": 122}
{"name": "oonexdl", "gender": "female", "age": 21, "weight": 122}
{"name": "oonexdl", "gender": "female", "age": 27, "weight": 126}
```
query:
```
db.me.find({"name": "oonexdl", "gender": "male", "age": {"$lte": 23}}).sort({weight: 1})
```
### 不使用索引

遍历所有 documents 进行 filter，也就是 `collscan`

### 建立索引

1. 错误示例

```
{weight: 1, name: 1, gender: 1} or {weight: 1}
```
- IXSCAN

将 weight 作为第一个 key 能命中索引，但无法通过索引过滤文档(查询条件中不包含　weight)，因此返回排好序的所有文档
```
{"name": "oonexdl", "gender": "female", "age": 23, "weight": 121}
{"name": "oonexdl", "gender": "male", "age": 21, "weight": 122}
{"name": "oonexdl", "gender": "female", "age": 22, "weight": 122}
{"name": "oonexdl", "gender": "female", "age": 21, "weight": 122}
{"name": "oonexdl", "gender": "female", "age": 22, "weight": 123}
{"name": "oonexdl", "gender": "male", "age": 20, "weight": 123}
{"name": "oonexdl", "gender": "male", "age": 23, "weight": 124}
{"name": "oonexdl", "gender": "female", "age": 27, "weight": 126}
{"name": "oonexdl", "gender": "male", "age": 21, "weight": 127}
```
- FILTER

遍历所有文档，过滤出符合条件的文档

2. 错误示例

```
{name: 1, gender: 1, age: -1, weight: 1}
```
- IXSCAN

虽然末尾 key 为 weight，但因为 age 不是精确匹配，因此拿到文档依然无序

```
{"name": "oonexdl", "gender": "male", "age": 23, "weight": 124}
{"name": "oonexdl", "gender": "male", "age": 21, "weight": 122}
{"name": "oonexdl", "gender": "male", "age": 21, "weight": 127}
{"name": "oonexdl", "gender": "male", "age": 20, "weight": 123}
```

- SORT_KEY_GENERATOR

```
[124, 122, 127, 123]
```

- SORT

内存中排序

```
{"name": "oonexdl", "gender": "male", "age": 21, "weight": 122}
{"name": "oonexdl", "gender": "male", "age": 20, "weight": 123}
{"name": "oonexdl", "gender": "male", "age": 23, "weight": 124}
{"name": "oonexdl", "gender": "male", "age": 21, "weight": 127}
```

3. 错误示例

```
{name: 1, gender: 1, weight: 1}
```

- IXSCAN

```
{"name": "oonexdl", "gender": "male", "age": 21, "weight": 122}
{"name": "oonexdl", "gender": "male", "age": 20, "weight": 123}
{"name": "oonexdl", "gender": "male", "age": 23, "weight": 124}
{"name": "oonexdl", "gender": "male", "age": 21, "weight": 127}
```

- FILTER

用 {age: {"$lte": 23}} 遍历上述文档，如果文档数量级过高，效率极低

4. 正确示例

```
{name: 1, gender: 1, weight: 1, age: 1}
```

- IXSCAN

排序和查询被索引完全 cover 住了，最优解
```
{"name": "oonexdl", "gender": "male", "age": 21, "weight": 122}
{"name": "oonexdl", "gender": "male", "age": 20, "weight": 123}
{"name": "oonexdl", "gender": "male", "age": 23, "weight": 124}
{"name": "oonexdl", "gender": "male", "age": 21, "weight": 127}
```
